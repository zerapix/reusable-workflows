# Normally called on pull_request events
on:
  workflow_call:
    inputs:
      reusable-ref:
        type: string
        default: main
        description: Reusable workflow branch/tag/etc I am being called in.

      dev-app-host:
        type: string
        description: Host name to link to (will prepend 'prs*' to start of host).
        required: true
jobs:
  get-prs-slot:
    runs-on: ubuntu-latest
    concurrency: get-pr-slot
    outputs:
      slot-num: ${{ steps.slot-num.outputs.result }}
    steps:
      - uses: zerapix/reusable-workflows/all-checkout@main
        with:
          reusable-ref: ${{ inputs.reusable-ref }}
      - uses: ./.reusable-workflows/js-setup-project

      # Get/Assign the prs* stage name for pr.
      - uses: actions/github-script@v6
        id: slot-num
        with:  # "pixydocs.dev.zerapix.com"
          script: |
            const script = require('./.reusable-workflows/scripts/get-pr-slot.js')
            const devAppHost = '${{ inputs.dev-app-host }}'
            return script({github, context, devAppHost})
      - run: echo "Assigned PR Slot (${{ steps.slot-num.outputs.result }})."

  deploy-prs:
    needs: get-prs-slot
    uses: zerapix/reusable-workflows/.github/workflows/js-deploy-w-sls.yml@main
    secrets: inherit
    with:
      environment: 'prs'
      override-stage-name: 'prs${{ needs.get-prs-slot.outputs.slot-num }}'
      pre-release: true
      reusable-ref: ${{ inputs.reusable-ref }}

#
#
#      # Dispatch a deployment workflow for the PR.
#      - name: Dispatch PR Deployment Workflow
#        uses: actions/github-script@v6
#        with:
#          # Run a new workflow job, using originating repo's standard `deployment.yml` via workflow_dispatch
#          script: |
#            github.rest.actions.createWorkflowDispatch({
#              owner: context.repo.owner,
#              repo: context.repo.repo,
#              workflow_id: 'deploy-pr.yml',
#              ref: 'refs/tags/${{ needs.create-release.outputs.release-tag }}',
#              inputs: {
#                environment: 'prs'
#                override-stage-name: 'prs${{ steps.slot-num.outputs.result }}'
#                pre-release: true
#              }
#            })
